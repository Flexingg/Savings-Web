<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Savings Board</title>
    
    <!-- Tailwind CSS with Configuration -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748',
                            850: '#1a202c', 
                            950: '#0d1117',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Hover effects for editable elements */
        .editable-area:hover { cursor: pointer; opacity: 0.8; transition: opacity 0.2s; }
        .editable-area:hover .edit-icon { display: inline-block; }
        .edit-icon { display: none; margin-left: 5px; font-size: 0.8em; }
        
        /* Smooth theme transition */
        html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
            transition-property: background-color, border-color, color, fill, stroke;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 300ms;
        }
    </style>
</head>
<body class="text-gray-800 bg-gray-50 dark:bg-gray-950 dark:text-gray-100 transition-colors duration-300">

    <!-- Theme Toggle Button -->
    <button onclick="toggleTheme()" class="fixed bottom-6 right-6 z-50 p-4 rounded-full bg-white dark:bg-gray-800 text-gray-800 dark:text-yellow-400 shadow-xl hover:scale-110 transition-transform duration-200 border border-gray-200 dark:border-gray-700">
        <i class="fas fa-sun hidden dark:block"></i>
        <i class="fas fa-moon block dark:hidden text-gray-600"></i>
    </button>

    <!-- Main Container -->
    <div class="max-w-6xl mx-auto p-4 md:p-6 space-y-6">

        <!-- Header & House Timeline -->
        <header onclick="openGoalModal()" class="bg-white dark:bg-gray-800 dark:border-gray-700 rounded-2xl p-6 card-shadow relative overflow-hidden editable-area group">
            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-green-100 dark:bg-green-900 rounded-full blur-2xl opacity-50"></div>
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 relative z-10">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white"><i class="fas fa-piggy-bank text-green-500 mr-2"></i>Family Savings Board</h1>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Jonathan & Kathy's Road to a New Home</p>
                </div>
                <div class="text-right mt-4 md:mt-0">
                    <div class="text-sm font-semibold text-gray-500 dark:text-gray-400 group-hover:text-blue-500 dark:group-hover:text-blue-400">House Goal: <span id="goal-display">$50,000</span> <i class="fas fa-pen edit-icon text-blue-500"></i></div>
                    <div class="text-3xl font-bold text-green-600 dark:text-green-400 group-hover:text-green-700 dark:group-hover:text-green-300" id="total-saved-display">$12,450</div>
                </div>
            </div>

            <!-- Timeline Bar -->
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 mb-2 relative">
                <div id="progress-bar" class="bg-gradient-to-r from-green-400 to-blue-500 h-4 rounded-full transition-all duration-1000 shadow-lg" style="width: 25%"></div>
            </div>
            <div class="flex justify-between text-xs font-medium text-gray-500 dark:text-gray-400" id="timeline-prediction">
                <span>Start</span>
                <span>Estimated Purchase: <span id="estimated-date" class="text-blue-600 dark:text-blue-400 font-bold">Calculating...</span></span>
            </div>
        </header>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Col: Weekly Stats Grid -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Chart Section -->
                <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl card-shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-gray-700 dark:text-gray-200">Weekly Savings Trends</h3>
                        <span onclick="openMaxModal()" class="text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 px-2 py-1 rounded-full cursor-pointer hover:bg-green-200 dark:hover:bg-green-800 transition">
                            Max Save: $<span id="daily-max-display">50</span>/day <i class="fas fa-pen ml-1 text-[10px]"></i>
                        </span>
                    </div>
                    <div class="h-64 w-full">
                        <canvas id="savingsChart"></canvas>
                    </div>
                </div>

                <!-- Weekly Breakdown Grid -->
                <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl card-shadow overflow-x-auto">
                    <h3 class="font-semibold text-gray-700 dark:text-gray-200 mb-4">Daily Breakdown</h3>
                    <div class="min-w-[600px]">
                        <div class="grid grid-cols-8 gap-2 text-center mb-2 text-xs font-bold text-gray-400 dark:text-gray-500 uppercase">
                            <div class="text-left pl-2">Person</div>
                            <div>Sun</div>
                            <div>Mon</div>
                            <div>Tue</div>
                            <div>Wed</div>
                            <div>Thu</div>
                            <div>Fri</div>
                            <div>Sat</div>
                        </div>
                        
                        <!-- Jonathan Row -->
                        <div class="grid grid-cols-8 gap-2 mb-3 items-center">
                            <div class="flex items-center space-x-2 pl-2">
                                <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-600 dark:text-blue-200 font-bold text-xs shadow-sm">J</div>
                                <span class="font-semibold text-sm hidden md:block text-gray-700 dark:text-gray-200">Jonathan</span>
                            </div>
                            <div id="row-jonathan" class="contents"></div>
                        </div>

                        <!-- Kathy Row -->
                        <div class="grid grid-cols-8 gap-2 items-center">
                            <div class="flex items-center space-x-2 pl-2">
                                <div class="w-8 h-8 rounded-full bg-pink-100 dark:bg-pink-900 flex items-center justify-center text-pink-600 dark:text-pink-200 font-bold text-xs shadow-sm">K</div>
                                <span class="font-semibold text-sm hidden md:block text-gray-700 dark:text-gray-200">Kathy</span>
                            </div>
                            <div id="row-kathy" class="contents"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Col: Expenses & Action -->
            <div class="space-y-6 flex flex-col">
                
                <!-- Expenses List -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl card-shadow h-96 flex flex-col order-1 lg:order-1">
                    <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                        <h3 class="font-semibold text-gray-700 dark:text-gray-200">Recent Expenses</h3>
                        <span class="text-xs text-gray-400">Click item to assign</span>
                    </div>
                    <div class="overflow-y-auto p-2 space-y-2 flex-1 no-scrollbar" id="expense-list">
                        <!-- Items injected by JS -->
                    </div>
                </div>

                <!-- Add Expense Form -->
                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl card-shadow border-l-4 border-blue-500 order-2 lg:order-2">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4">Add Expense</h3>
                    <form id="add-expense-form" class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Description</label>
                            <input type="text" id="desc-input" placeholder="e.g., Groceries, Gas" required class="w-full p-2 border border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Amount ($)</label>
                                <input type="number" id="amount-input" step="0.01" placeholder="0.00" required class="w-full p-2 border border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Day</label>
                                <select id="day-input" class="w-full p-2 border border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option value="0">Sunday</option>
                                    <option value="1">Monday</option>
                                    <option value="2">Tuesday</option>
                                    <option value="3">Wednesday</option>
                                    <option value="4">Thursday</option>
                                    <option value="5">Friday</option>
                                    <option value="6">Saturday</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Who paid?</label>
                            <select id="who-input" class="w-full p-2 border border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="Jonathan">Jonathan</option>
                                <option value="Kathy">Kathy</option>
                                <option value="Both">Both</option>
                                <option value="Neither">Neither</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition duration-200 shadow-md">
                            <i class="fas fa-plus mr-2"></i>Add Expense
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- --- Modals --- -->

    <!-- Assignment Modal -->
    <div id="assign-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 dark:bg-opacity-80 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-80 transform transition-all scale-100 border border-gray-100 dark:border-gray-700">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-blue-50 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-2">
                    <i class="fas fa-tags text-blue-500 dark:text-blue-400 text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">Assign to:</h3>
                <p id="modal-item-desc" class="text-sm text-gray-500 dark:text-gray-400 mt-1">Coffee at Starbucks</p>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="assignExpense('Jonathan')" class="p-3 rounded-xl border border-gray-200 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-blue-900/50 hover:border-blue-500 hover:bg-blue-50 transition text-sm font-medium text-gray-700">Jonathan</button>
                <button onclick="assignExpense('Kathy')" class="p-3 rounded-xl border border-gray-200 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-pink-900/50 hover:border-pink-500 hover:bg-pink-50 transition text-sm font-medium text-gray-700">Kathy</button>
                <button onclick="assignExpense('Both')" class="p-3 rounded-xl border border-gray-200 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-purple-900/50 hover:border-purple-500 hover:bg-purple-50 transition text-sm font-medium text-gray-700">Both</button>
                <button onclick="assignExpense('Neither')" class="p-3 rounded-xl border border-gray-200 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-gray-700 hover:border-gray-500 hover:bg-gray-50 transition text-sm font-medium text-gray-700">Neither</button>
            </div>
            <button onclick="closeModal('assign-modal')" class="mt-4 w-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-sm">Cancel</button>
        </div>
    </div>

    <!-- Goal Edit Modal -->
    <div id="goal-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 dark:bg-opacity-80 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-80 border border-gray-100 dark:border-gray-700">
            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Update House Goals</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Current Savings</label>
                    <input type="number" id="edit-current-savings" class="w-full p-2 border border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded mt-1">
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Goal Amount</label>
                    <input type="number" id="edit-goal-amount" class="w-full p-2 border border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded mt-1">
                </div>
            </div>
            <button onclick="saveGoals()" class="mt-4 w-full bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600">Save Changes</button>
            <button onclick="closeModal('goal-modal')" class="mt-2 w-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-sm">Cancel</button>
        </div>
    </div>

    <!-- Max Save Edit Modal -->
    <div id="max-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 dark:bg-opacity-80 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-80 border border-gray-100 dark:border-gray-700">
            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Daily Limit</h3>
            <div>
                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Max Savings per Person/Day</label>
                <input type="number" id="edit-daily-max" class="w-full p-2 border border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded mt-1">
            </div>
            <button onclick="saveMax()" class="mt-4 w-full bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600">Update Limit</button>
            <button onclick="closeModal('max-modal')" class="mt-2 w-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-sm">Cancel</button>
        </div>
    </div>

    <!-- Edit Expense Modal -->
    <div id="edit-expense-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 dark:bg-opacity-80 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-96 border border-gray-100 dark:border-gray-700">
            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Edit Expense</h3>
            <form id="edit-expense-form" class="space-y-3">
                <div>
                    <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Description</label>
                    <input type="text" id="edit-desc-input" required class="w-full p-2 border border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Amount ($)</label>
                        <input type="number" id="edit-amount-input" step="0.01" required class="w-full p-2 border border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Day</label>
                        <select id="edit-day-input" class="w-full p-2 border border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            <option value="0">Sunday</option>
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Who paid?</label>
                    <select id="edit-who-input" class="w-full p-2 border border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        <option value="Jonathan">Jonathan</option>
                        <option value="Kathy">Kathy</option>
                        <option value="Both">Both</option>
                        <option value="Neither">Neither</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg transition duration-200 shadow-md">
                    Save Changes
                </button>
                <button type="button" onclick="closeModal('edit-expense-modal')" class="mt-2 w-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-sm">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        // --- Theme Logic ---
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
            // Trigger UI update to refresh class-based conditional rendering if necessary
            updateUI(); 
        }

        // Initialize Theme immediately
        initTheme();

        // --- Configuration ---
        // In a real app, these would be null initially and populated by fetch()
        let DAILY_MAX = 50;
        let HOUSE_GOAL = 50000;
        let currentTotalSavings = 12450; 
        
        // --- State ---
        let expenses = [
            { id: 1, desc: "Expense 1", amount: 10.00, who: "Both", day: 1 },
            { id: 2, desc: "Expense 2", amount: 20.00, who: "Both", day: 2 },
            { id: 3, desc: "Expense 3", amount: 30.00, who: "Both", day: 3 },
            { id: 4, desc: "Expense 5", amount: 40.00, who: "Kathy", day: 5 },
        ];

        let selectedExpenseId = null;
        let savingsChart = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Uncomment to use real backend:
            // fetchAllData();
            updateUI();
        });

        // --- Data Fetching (Simulated) ---
        async function fetchAllData() {
            try {
                const res = await fetch('http://localhost:5000/api/data');
                const data = await res.json();
                
                DAILY_MAX = data.settings.daily_max;
                HOUSE_GOAL = data.settings.house_goal;
                currentTotalSavings = data.settings.current_savings;
                expenses = data.expenses;
                
                updateUI();
            } catch (e) {
                console.error("Failed to fetch backend data. Is app.py running?");
            }
        }

        // --- Core Logic ---

        function calculateDailySavings() {
            // Initialize week structure: 0=Sun, 6=Sat
            let weekData = {
                Jonathan: Array(7).fill(DAILY_MAX),
                Kathy: Array(7).fill(DAILY_MAX)
            };

            expenses.forEach(exp => {
                const person = exp.who; // "Jonathan" or "Kathy" or "Both" or "Neither"
                const day = parseInt(exp.day);
                
                if (person === "Jonathan" || person === "Both") {
                    weekData.Jonathan[day] -= exp.amount / (person === "Both" ? 2 : 1);
                }
                if (person === "Kathy" || person === "Both") {
                    weekData.Kathy[day] -= exp.amount / (person === "Both" ? 2 : 1);
                }
            });

            return weekData;
        }

        function updateUI() {
            const weekData = calculateDailySavings();
            
            document.getElementById('goal-display').innerText = `$${HOUSE_GOAL.toLocaleString()}`;
            document.getElementById('daily-max-display').innerText = DAILY_MAX;
            
            renderGrid(weekData);
            renderChart(weekData);
            renderExpenseList();
            updateTimeline(weekData);
        }

        // --- Rendering Components ---

        function renderGrid(weekData) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            ['Jonathan', 'Kathy'].forEach(person => {
                const container = document.getElementById(`row-${person.toLowerCase()}`);
                container.innerHTML = '';

                weekData[person].forEach((saved, index) => {
                    // Determine color based on savings - updated for Dark Mode
                    let bgClass = 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300 border-green-200 dark:border-green-800';
                    if (saved < 0) bgClass = 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300 border-red-200 dark:border-red-800';
                    else if (saved < (DAILY_MAX * 0.4)) bgClass = 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300 border-yellow-200 dark:border-yellow-800';

                    const cell = document.createElement('div');
                    cell.className = `h-12 rounded-lg flex flex-col items-center justify-center text-sm font-bold border ${bgClass} transition-colors duration-300`;
                    cell.innerHTML = `<span>$${saved.toFixed(0)}</span>`;
                    container.appendChild(cell);
                });
            });
        }

        function renderExpenseList() {
            const list = document.getElementById('expense-list');
            list.innerHTML = '';

            const sortedExpenses = [...expenses].sort((a, b) => b.id - a.id);

            sortedExpenses.forEach(exp => {
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                
                const item = document.createElement('div');
                item.className = 'p-3 rounded-xl bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 transition cursor-pointer flex justify-between items-center group border border-transparent dark:border-gray-600';
                item.onclick = () => openAssignModal(exp.id);

                let tagColor = "bg-gray-200 text-gray-600 dark:bg-gray-600 dark:text-gray-300";
                if(exp.who === "Jonathan") tagColor = "bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300";
                if(exp.who === "Kathy") tagColor = "bg-pink-100 text-pink-600 dark:bg-pink-900 dark:text-pink-300";
                if(exp.who === "Both") tagColor = "bg-purple-100 text-purple-600 dark:bg-purple-900 dark:text-purple-300";

                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-white dark:bg-gray-600 flex items-center justify-center shadow-sm text-gray-500 dark:text-gray-300">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-gray-800 dark:text-gray-100">${exp.desc}</p>
                            <span class="text-[10px] text-gray-400 dark:text-gray-400">${days[exp.day]}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-gray-800 dark:text-gray-100">-$${exp.amount.toFixed(2)}</p>
                        <span class="text-[10px] px-2 py-0.5 rounded-full ${tagColor} uppercase font-bold">${exp.who || '?'}</span>
                    </div>
                    <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="event.stopPropagation(); openEditExpenseModal(${exp.id})" class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteExpense(${exp.id})" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function updateTimeline(weekData) {
            const weeklyTotal = 
                weekData.Jonathan.reduce((a, b) => a + b, 0) + 
                weekData.Kathy.reduce((a, b) => a + b, 0);
            
            const weeklyRate = weeklyTotal > 0 ? weeklyTotal : 1; 
            
            const remaining = HOUSE_GOAL - currentTotalSavings;
            const weeksLeft = Math.ceil(remaining / weeklyRate);
            
            const today = new Date();
            const targetDate = new Date(today.setDate(today.getDate() + (weeksLeft * 7)));
            const options = { year: 'numeric', month: 'short' };

            const percentage = Math.min(100, (currentTotalSavings / HOUSE_GOAL) * 100);

            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('estimated-date').innerText = weeksLeft > 500 ? "Requires more savings" : targetDate.toLocaleDateString('en-US', options);
            document.getElementById('total-saved-display').innerText = `$${currentTotalSavings.toLocaleString()}`;
        }

        function renderChart(weekData) {
            const ctx = document.getElementById('savingsChart').getContext('2d');
            
            if (savingsChart) {
                savingsChart.destroy();
            }

            // Detect theme for chart colors
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            savingsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                    datasets: [
                        {
                            label: 'Jonathan',
                            data: weekData.Jonathan,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Kathy',
                            data: weekData.Kathy,
                            borderColor: '#db2777',
                            backgroundColor: 'rgba(219, 39, 119, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: { color: textColor }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: DAILY_MAX + 10,
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    }
                }
            });
        }

        // --- Modal Interactions ---

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            selectedExpenseId = null;
        }

        // 1. Assignment Modal
        function openAssignModal(id) {
            selectedExpenseId = id;
            const exp = expenses.find(e => e.id === id);
            document.getElementById('modal-item-desc').innerText = `${exp.desc} ($${exp.amount})`;
            document.getElementById('assign-modal').classList.remove('hidden');
        }

        async function assignExpense(who) {
            if (selectedExpenseId !== null) {
                const expIndex = expenses.findIndex(e => e.id === selectedExpenseId);
                if (expIndex !== -1) {
                    // Simulated API Call:
                    // const res = await fetch(`http://localhost:5000/api/expenses/${selectedExpenseId}`, ...);
                    // Update local state directly for frontend demo
                    expenses[expIndex].who = who;
                }
            }
            closeModal('assign-modal');
            updateUI();
        }

        // 2. Goal Edit Modal
        function openGoalModal() {
            document.getElementById('edit-current-savings').value = currentTotalSavings;
            document.getElementById('edit-goal-amount').value = HOUSE_GOAL;
            document.getElementById('goal-modal').classList.remove('hidden');
        }

        async function saveGoals() {
            currentTotalSavings = parseFloat(document.getElementById('edit-current-savings').value);
            HOUSE_GOAL = parseFloat(document.getElementById('edit-goal-amount').value);
            
            // API Call simulation
            closeModal('goal-modal');
            updateUI();
        }

        // 3. Max Save Edit Modal
        function openMaxModal() {
            document.getElementById('edit-daily-max').value = DAILY_MAX;
            document.getElementById('max-modal').classList.remove('hidden');
        }

        async function saveMax() {
            DAILY_MAX = parseFloat(document.getElementById('edit-daily-max').value);
            closeModal('max-modal');
            updateUI();
        }

        // 4. Edit Expense Modal
        function openEditExpenseModal(id) {
            selectedExpenseId = id;
            const exp = expenses.find(e => e.id === id);
            if (exp) {
                document.getElementById('edit-desc-input').value = exp.desc;
                document.getElementById('edit-amount-input').value = exp.amount;
                document.getElementById('edit-day-input').value = exp.day;
                document.getElementById('edit-who-input').value = exp.who;
                document.getElementById('edit-expense-modal').classList.remove('hidden');
            }
        }

        document.getElementById('edit-expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (selectedExpenseId === null) return;

            const desc = document.getElementById('edit-desc-input').value;
            const amount = parseFloat(document.getElementById('edit-amount-input').value);
            const who = document.getElementById('edit-who-input').value;
            const day = parseInt(document.getElementById('edit-day-input').value);

            const expIndex = expenses.findIndex(e => e.id === selectedExpenseId);
            if (expIndex !== -1) {
                expenses[expIndex] = { ...expenses[expIndex], desc, amount, who, day };
            }

            closeModal('edit-expense-modal');
            updateUI();
        });

        async function deleteExpense(id) {
            if (confirm('Are you sure you want to delete this expense?')) {
                // API Call simulation
                expenses = expenses.filter(exp => exp.id !== id);
                updateUI();
            }
        }


        // --- Form Handling ---

        document.getElementById('add-expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const desc = document.getElementById('desc-input').value;
            const amount = parseFloat(document.getElementById('amount-input').value);
            const who = document.getElementById('who-input').value;
            const day = parseInt(document.getElementById('day-input').value);

            const newExpense = {
                id: Date.now(),
                desc,
                amount,
                who,
                day
            };
            
            // Real API Push simulation
            expenses.push(newExpense);
            
            e.target.reset();
            updateUI();
        });

    </script>
</body>
</html>